<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parallel Tempering • drjacoby</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Parallel Tempering">
<meta property="og:description" content="drjacoby">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">drjacoby</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.5.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/installation.html">Installation</a>
    </li>
    <li>
      <a href="../articles/example.html">Basic Example</a>
    </li>
    <li>
      <a href="../articles/metropolis_coupling.html">Parallel Tempering</a>
    </li>
    <li>
      <a href="../articles/parallel.html">Running Parallel Chains</a>
    </li>
    <li>
      <a href="../articles/getting_model_fits.html">Getting Model Fits</a>
    </li>
    <li>
      <a href="../articles/blocks.html">Using Likelihood Blocks</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Checks
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/checks_return_prior.html">Return prior</a>
    </li>
    <li>
      <a href="../articles/checks_normal_model.html">Normal model</a>
    </li>
    <li>
      <a href="../articles/checks_double_well.html">Double well</a>
    </li>
    <li>
      <a href="../articles/checks_multilevel_blocks.html">Multilevel blocks</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/drjacoby" class="external-link">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Parallel Tempering</h1>
                        <h4 data-toc-skip class="author">Bob Verity and
Pete Winskill</h4>
            
            <h4 data-toc-skip class="date">2024-06-26</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/drjacoby/blob/HEAD/vignettes/metropolis_coupling.Rmd" class="external-link"><code>vignettes/metropolis_coupling.Rmd</code></a></small>
      <div class="hidden name"><code>metropolis_coupling.Rmd</code></div>

    </div>

    
    
<pre><code><span><span class="co">#&gt; Registered S3 method overwritten by 'GGally':</span></span>
<span><span class="co">#&gt;   method from   </span></span>
<span><span class="co">#&gt;   +.gg   ggplot2</span></span></code></pre>
<p>MCMC becomes considerably harder when the posterior distribution is
1) highly correlated, and/or 2) highly multimodal. For exampe, if your
posterior has Twin Peaks then ordinary Metropolis-Hastings might not be
enough. Parallel tempering tends to mitigate these problems and requires
nothing more than some extra heated chains.</p>
<p>This vignette demonstrates how parallel tempering can be implemented
within <em>drjacoby</em> to solve a deliberately awkward MCMC
problem.</p>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>For this example we will start by writing the likelihood and prior
functions in C++. If this sounds unfamiliar to you, check out the <a href="https://mrc-ide.github.io/drjacoby/articles/example.html" class="external-link">earlier
vignette</a> for a simple example. Our basic model will assume that our
data are normally distributed with mean <code>alpha^2*beta</code>. The
<code>alpha^2</code> term here means that both positive and negative
values of <code>alpha</code> map to the same value, thereby creating a
multimodal distribution. The <code>*beta</code> term ensures that
<code>alpha</code> and <code>beta</code> are highly correlated. We will
also use a third parameter <code>epsilon</code> to represent some random
noise that we want to integrate over. While this is a highly contrived
example, it does have the advantage of being horrendously awkward!</p>
<p>For our prior we assume that <code>alpha</code> is uniform [-10,10],
<code>beta</code> is uniform [0,10], and <code>epsilon</code> is
normally distributed with mean 0 and standard deviation 1.</p>
<pre><code>#include &lt;Rcpp.h&gt;
using namespace Rcpp;

// [[Rcpp::export]]
SEXP loglike(Rcpp::NumericVector params, Rcpp::List data, Rcpp::List misc) {
  
  // unpack data
  std::vector&lt;double&gt; x = Rcpp::as&lt; std::vector&lt;double&gt; &gt;(data["x"]);
  
  // unpack parameters
  double alpha = params["alpha"];
  double beta = params["beta"];
  double epsilon = params["epsilon"];
  
  // sum log-likelihood over all data
  double mean = alpha*alpha*beta + epsilon;
  double ret = 0.0;
  for (unsigned int i = 0; i &lt; x.size(); ++i) {
    ret += R::dnorm(x[i], mean, 1.0, true);
  }
  
  // return as SEXP
  return Rcpp::wrap(ret);
}

// [[Rcpp::export]]
SEXP logprior(Rcpp::NumericVector params, Rcpp::List misc) {
  
  // unpack parameters
  double epsilon = params["epsilon"];
  
  // calculate logprior
  double ret = -log(20.0) - log(10.0) + R::dnorm(epsilon, 0.0, 1.0, true);
  
  // return as SEXP
  return Rcpp::wrap(ret);
}

// [[Rcpp::export]]  
SEXP create_xptr(std::string function_name) {  
  typedef SEXP (*funcPtr_likelihood)(Rcpp::NumericVector params, Rcpp::List data, Rcpp::List misc);  
  typedef SEXP (*funcPtr_prior)(Rcpp::NumericVector params, Rcpp::List misc);  
  
  if (function_name == "loglike"){
    return(Rcpp::XPtr&lt;funcPtr_likelihood&gt;(new funcPtr_likelihood(&amp;loglike)));
  } 
  if (function_name == "logprior"){
    return(Rcpp::XPtr&lt;funcPtr_prior&gt;(new funcPtr_prior(&amp;logprior)));
  } 
  
  stop("cpp function %i not found", function_name);
}</code></pre>
<p>As always, we need to define a dataframe of parameters so that
<em>drjacoby</em> knows what parameter ranges to expect:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># define parameters dataframe</span></span>
<span><span class="va">df_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/define_params.html">define_params</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"alpha"</span>, min <span class="op">=</span> <span class="op">-</span><span class="fl">10</span>, max <span class="op">=</span> <span class="fl">10</span>, init <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                           name <span class="op">=</span> <span class="st">"beta"</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">10</span>, init <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                           name <span class="op">=</span> <span class="st">"epsilon"</span>, min <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, max <span class="op">=</span> <span class="cn">Inf</span>, init <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p>Finally, we need some data. For simplicity we will use a series of
values drawn from a normal distribution with mean 10. These are
obviously not drawn from the true model, but will have the advantage of
creating a horribly awkward posterior.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># draw example data</span></span>
<span><span class="va">data_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>, mean <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="running-the-mcmc">Running the MCMC<a class="anchor" aria-label="anchor" href="#running-the-mcmc"></a>
</h2>
<p>First, we will try running the basic MCMC without parallel tempering.
The following block of code repeats the same MCMC analysis nine times,
each time producing a plot of posterior <code>alpha</code> against
<code>beta</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># run MCMC</span></span>
<span>  <span class="va">mcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_mcmc.html">run_mcmc</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_list</span>,</span>
<span>                   df_params <span class="op">=</span> <span class="va">df_params</span>,</span>
<span>                   loglike <span class="op">=</span> <span class="st">"loglike"</span>,</span>
<span>                   logprior <span class="op">=</span> <span class="st">"logprior"</span>,</span>
<span>                   burnin <span class="op">=</span> <span class="fl">1e3</span>,</span>
<span>                   samples <span class="op">=</span> <span class="fl">1e4</span>,</span>
<span>                   chains <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                   silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># create plot of alpha against beta</span></span>
<span>  <span class="va">plot_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_scatter.html">plot_scatter</a></span><span class="op">(</span><span class="va">mcmc</span>, <span class="st">"alpha"</span>, <span class="st">"beta"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># plot grid</span></span>
<span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span>grobs <span class="op">=</span> <span class="va">plot_list</span><span class="op">)</span></span></code></pre></div>
<p><img src="metropolis_coupling_files/figure-html/unnamed-chunk-5-1.png" width="768"></p>
<p>Clearly this MCMC is not mixing well! By looking over all nine plots
we can get a rough idea of what the distribution <em>should</em> look
like, but no single MCMC run has captured it adequately. You can
experiment with increasing the number of samples - you should get better
results for more samples, but a <em>very</em> large number of samples
are needed before we get good mixing between the left and right sides of
the distribution.</p>
<p>Parallel tempering is perfectly designed to solve this kind of
problem. To activate parallel tempering we need to specify an additional
argument to the <code><a href="../reference/run_mcmc.html">run_mcmc()</a></code> function - the number of
<code>rungs</code>. Each rung represents a different MCMC chain arranged
in a “temperature ladder”, with the hotter chains being more free to
explore the parameter space. Every iteration, chains have the option of
swapping parameter values between rungs, thereby allowing the
freely-moving hot chains to propose values to the more constrained
colder chains. When looking at the output, we tend to focus exclusively
on the coldest chain which can be interpreted the same way as a single
chain from regular MCMC.</p>
<p>In this example we use 20 rungs:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run MCMC</span></span>
<span><span class="va">mcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_mcmc.html">run_mcmc</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_list</span>,</span>
<span>                 df_params <span class="op">=</span> <span class="va">df_params</span>,</span>
<span>                 loglike <span class="op">=</span> <span class="st">"loglike"</span>,</span>
<span>                 logprior <span class="op">=</span> <span class="st">"logprior"</span>,</span>
<span>                 burnin <span class="op">=</span> <span class="fl">1e3</span>,</span>
<span>                 samples <span class="op">=</span> <span class="fl">1e4</span>,</span>
<span>                 rungs <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                 chains <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                 pb_markdown <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; MCMC chain 1</span></span>
<span><span class="co">#&gt; burn-in</span></span>
<span><span class="co">#&gt;   |                                                                              |======================================================================| 100%</span></span>
<span><span class="co">#&gt; acceptance rate: 42.5%</span></span>
<span><span class="co">#&gt; sampling phase</span></span>
<span><span class="co">#&gt;   |                                                                              |======================================================================| 100%</span></span>
<span><span class="co">#&gt; acceptance rate: 44%</span></span>
<span><span class="co">#&gt; chain completed in 1.126265 seconds</span></span>
<span><span class="co">#&gt; total MCMC run-time: 1.13 seconds</span></span>
<span></span>
<span><span class="co"># create plot of alpha against beta</span></span>
<span><span class="fu"><a href="../reference/plot_scatter.html">plot_scatter</a></span><span class="op">(</span><span class="va">mcmc</span>, <span class="st">"alpha"</span>, <span class="st">"beta"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p><img src="metropolis_coupling_files/figure-html/unnamed-chunk-6-1.png" width="480"></p>
<p>You should see a much better characterisation of the posterior
distribution. The run time scales approximately linearly with the number
of rungs, so there is a computational cost to using this method, but on
the other hand our results are far better than we would obtain by simply
increasing the number of samples by a factor of 20.</p>
</div>
<div class="section level2">
<h2 id="how-many-rungs-to-use">How many rungs to use?<a class="anchor" aria-label="anchor" href="#how-many-rungs-to-use"></a>
</h2>
<p>Parallel tempering in <em>drjacoby</em> works by proposing swaps
between adjacent rungs in the temperature ladder, which are accepted or
rejected according to the standard Metropolis-Hastings ratio. If, for
example, a hot rung happens upon a set of parameter values that have
high likelihood then there is a good chance these values will be swapped
up to the next rung. In this way, information can effectively
bubble-sort its way from the prior (the hottest chain) to the posterior
(the coldest chain). The average chance of a swap being accepted depends
on the two adjacent rungs being similar enough in distribution that
values drawn from one have a high likelihood in the other. This, in
turn, means that swaps have a higher chance of being accepted when we
have a large number of densely packed rungs.</p>
<p>To explore this, we start by re-running the above MCMC with a small
number of rungs and a small number of samples to highlight the problem.
We can use the <code><a href="../reference/plot_mc_acceptance.html">plot_mc_acceptance()</a></code> function to plot the
acceptance rate between rungs:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run MCMC</span></span>
<span><span class="va">mcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_mcmc.html">run_mcmc</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_list</span>,</span>
<span>                 df_params <span class="op">=</span> <span class="va">df_params</span>,</span>
<span>                 loglike <span class="op">=</span> <span class="st">"loglike"</span>,</span>
<span>                 logprior <span class="op">=</span> <span class="st">"logprior"</span>,</span>
<span>                 burnin <span class="op">=</span> <span class="fl">1e3</span>,</span>
<span>                 samples <span class="op">=</span> <span class="fl">1e3</span>,</span>
<span>                 rungs <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                 chains <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                 silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot coupling acceptance rates</span></span>
<span><span class="fu"><a href="../reference/plot_mc_acceptance.html">plot_mc_acceptance</a></span><span class="op">(</span><span class="va">mcmc</span>, x_axis_type <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="metropolis_coupling_files/figure-html/unnamed-chunk-7-1.png" width="480"></p>
<p>The 10 vertical grey bars in the above plot show the positions of our
10 rungs in the thermodynamic interval [0,1], and the red dots between
them show the proportion of swaps that were accepted between rungs (this
information is available via <code>mcmc$diagnostics$mc_accept</code>).
Notice that the acceptance rate between the hottest and second-hottest
rung is close to zero, meaning very little of the information in the
hottest rung made it up the ladder to the colder rungs. We can see the
problems this causes when we plot the posterior draws:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_scatter.html">plot_scatter</a></span><span class="op">(</span><span class="va">mcmc</span>, <span class="st">"alpha"</span>, <span class="st">"beta"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p><img src="metropolis_coupling_files/figure-html/unnamed-chunk-8-1.png" width="480"></p>
<p>Although we have some mixing between the left and right sides of the
distribution, overall sampling is still very patchy.</p>
<p>One way of improving mixing between rungs is simply to increase the
number of rungs so the distance between distributions is smaller:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run MCMC</span></span>
<span><span class="va">mcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_mcmc.html">run_mcmc</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_list</span>,</span>
<span>                 df_params <span class="op">=</span> <span class="va">df_params</span>,</span>
<span>                 loglike <span class="op">=</span> <span class="st">"loglike"</span>,</span>
<span>                 logprior <span class="op">=</span> <span class="st">"logprior"</span>,</span>
<span>                 burnin <span class="op">=</span> <span class="fl">1e3</span>,</span>
<span>                 samples <span class="op">=</span> <span class="fl">1e3</span>,</span>
<span>                 rungs <span class="op">=</span> <span class="fl">50</span>,</span>
<span>                 chains <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                 silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot coupling acceptance rates</span></span>
<span><span class="fu"><a href="../reference/plot_mc_acceptance.html">plot_mc_acceptance</a></span><span class="op">(</span><span class="va">mcmc</span>, x_axis_type <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="metropolis_coupling_files/figure-html/unnamed-chunk-9-1.png" width="480"></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># create plot of alpha against beta</span></span>
<span><span class="fu"><a href="../reference/plot_scatter.html">plot_scatter</a></span><span class="op">(</span><span class="va">mcmc</span>, <span class="st">"alpha"</span>, <span class="st">"beta"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p><img src="metropolis_coupling_files/figure-html/unnamed-chunk-9-2.png" width="480"></p>
<p>This has helped, as we now have acceptance rates going “deeper”
towards the prior, however the hottest rung is still not passing
information up the ladder. This strategy also comes at a high
computational cost, as we are effectively running the MCMC algorithm 50
times. A more efficient method is usually to change the distribution of
rungs so they are more concentrated at low thermodynamic powers
(i.e. near the prior end of the spectrum). This can be achieved through
the parameter <code>alpha</code>, which represents a power that the
temperature ladder is raised to. Higher values of <code>alpha</code>
therefore lead to rungs being more concentrated at the prior end of the
spectrum. The previous two MCMCs had <code>alpha</code> set to 1.0 by
default, leading to evenly distributed rungs between [0,1]. Now we
repeat the MCMC with just 20 rungs and <code>alpha = 5.0</code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run MCMC</span></span>
<span><span class="va">mcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_mcmc.html">run_mcmc</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_list</span>,</span>
<span>                 df_params <span class="op">=</span> <span class="va">df_params</span>,</span>
<span>                 loglike <span class="op">=</span> <span class="st">"loglike"</span>,</span>
<span>                 logprior <span class="op">=</span> <span class="st">"logprior"</span>,</span>
<span>                 burnin <span class="op">=</span> <span class="fl">1e3</span>,</span>
<span>                 samples <span class="op">=</span> <span class="fl">1e3</span>,</span>
<span>                 rungs <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                 chains <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                 alpha <span class="op">=</span> <span class="fl">5.0</span>,</span>
<span>                 silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot coupling acceptance rates</span></span>
<span><span class="co"># we could also use the option x_axis_type = 1 if we wanted to see these</span></span>
<span><span class="co"># points spread out evenly, rather than at their true position in the</span></span>
<span><span class="co"># thermodynamic interval</span></span>
<span><span class="fu"><a href="../reference/plot_mc_acceptance.html">plot_mc_acceptance</a></span><span class="op">(</span><span class="va">mcmc</span>, x_axis_type <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="metropolis_coupling_files/figure-html/unnamed-chunk-10-1.png" width="480"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># create plot of alpha against beta</span></span>
<span><span class="fu"><a href="../reference/plot_scatter.html">plot_scatter</a></span><span class="op">(</span><span class="va">mcmc</span>, parameter1 <span class="op">=</span> <span class="st">"alpha"</span>, <span class="st">"beta"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p><img src="metropolis_coupling_files/figure-html/unnamed-chunk-10-2.png" width="480"></p>
<p>We find that with just 20 rungs we now have decent acceptance rates
all the way through the temperature ladder. If we really wanted to
fine-tune the mixing we could use the <code>beta_manual</code> argument
inside <code><a href="../reference/run_mcmc.html">run_mcmc()</a></code> to define the temperature ladder exactly
as a vector of values between 0 and 1. Note, this ladder is always
raised to the power <code>alpha</code>, so we should set
<code>alpha=1.0</code> if we don’t want any additional transformation
applied.</p>
<p>In summary, the correct number of rungs to use in parallel tempered
MCMC is whatever number provides decent acceptance rates all the way
through our temperature ladder. When this is the case we can be
condifent that the prior is “talking to” the posterior, making it
<em>extremely unlikely</em> (but not impossible) that the MCMC is still
missing large parts of the posterior distribution.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Bob Verity, Pete Winskill.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
